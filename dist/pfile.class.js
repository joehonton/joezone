var FS=require("fs"),Log=require("./log.class.js"),expect=require("./expect.function.js");module.exports=class Pfile{constructor(path){void 0==path&&(path=""),"Pfile"==path.constructor.name?this._copyConstructor(path):"Object"==path.constructor.name&&"_filename"in path?this._copyConstructor(path):this._normalConstructor(path),Object.seal(this)}_normalConstructor(path){expect(path,"String"),this.setPath(path)}_copyConstructor(rhs){expect(rhs,"Pfile"),this._filename=rhs._filename}get name(){return this._filename}setPath(path){return expect(path,"String"),this._filename=Pfile.posixStyle(path),this}addPath(path){expect(path,["String","Pfile"]),"Pfile"==path.constructor.name&&(path=path.name),path=Pfile.posixStyle(path);var len=this._filename.length;return len>0&&"/"!=this._filename.charAt(len-1)?this._filename+="/"+path:this._filename+=path,this.canonicalize(),this}addPathBefore(path){expect(path,"String"),path=Pfile.posixStyle(path),this.isAbsolutePath()&&log.logic(`Attempting to add the path "${path}" before the absolute filename "${this._filename}" is probably not what you want.`);var len=path.length;return len>0&&"/"!=path.charAt(len-1)?this._filename=path+"/"+this._filename:this._filename=path+this._filename,this.canonicalize(),this}canonicalize(){this._filename=this._filename.replace("/./","/"),this._filename=this._filename.replace("//","/");for(var b=!0;b;)b=this.removeDoubleDots();var len=this._filename.length;len>1&&"/"==this._filename.charAt(len-1)&&(this._filename=this._filename.substr(0,len-1))}removeDoubleDots(){var parts=this._filename.split("/");for(let i=1;i<parts.length-1;i++)if(".."!=parts[i-1]&&".."==parts[i])return parts.splice(i-1,2),this._filename=parts.join("/"),!0;return!1}static getCwd(){return Pfile.posixStyle(process.cwd())}makeAbsolute(relativeTo){if(this.isAbsolutePath())return this;if(relativeTo=void 0==relativeTo?Pfile.getCwd():Pfile.posixStyle(relativeTo),expect(relativeTo,"String"),0==this._filename.length)return this._filename=relativeTo,this;var tmp=new Pfile(relativeTo);return tmp.isAbsolutePath()?(this.addPathBefore(relativeTo),this):(log.logic(`Attempting to make "${this._filename}" absolute by prefixing it with the non-absolute path "${relativeTo}" won't work.`),this)}getFQN(){return this._filename}getPath(){if(this.isDirectory())return this._filename;var parts=this._filename.split("/");return parts.splice(0,parts.length-1).join("/")}getFilename(){if(this.isDirectory())return"";var parts=this._filename.split("/");return parts[parts.length-1]}getStem(){var filename=this.getFilename(),parts=filename.split(".");return parts.length<=1?filename:2==parts.length&&0==parts[0].length?filename:parts.splice(0,parts.length-1).join(".")}getExtension(){var parts=this.getFilename().split(".");return parts.length<=1?"":2==parts.length&&0==parts[0].length?"":parts[parts.length-1]}addExtension(ext){return this._filename=`${this._filename}.${ext}`,this}replaceExtension(ext){var path=this.getPath(),stem=this.getStem();return this._filename=`${path}/${stem}.${ext}`,this}exists(){try{return FS.accessSync(this._filename,FS.F_OK),!0}catch(e){return!1}}unlinkFile(){try{return!(!this.exists()||!this.isFile())&&(FS.unlinkSync(this._filename),!0)}catch(e){return!1}}rmDir(){try{return!(!this.exists()||!this.isDirectory())&&(FS.rmdirSync(this._filename),!0)}catch(e){return!1}}mkDir(){if(this.exists())return!0;var path=new Pfile(this);path.makeAbsolute();var parts=path._filename.split("/");parts[0].length>1&&":"==parts[0].charAt(1)&&(parts[0]=parts[0].substr(2));var assemble=new Pfile("/");for(let i=0;i<parts.length;i++)if(parts[i].length>0&&(assemble.addPath(parts[i]),!assemble.exists()))try{FS.mkdirSync(assemble.getFQN())}catch(e){return!1}return!0}isAbsolutePath(){return 0!=this._filename.length&&("/"==this._filename.charAt(0)||this._filename.length>1&&":"==this._filename.charAt(1))}isRelativePath(){return 0!=this._filename.length&&!this.isAbsolutePath()}isDottedPath(){return 0!=this._filename.length&&"."==this._filename.charAt(0)}isDirectory(){try{var stats=FS.lstatSync(this._filename);return stats.isDirectory()}catch(e){return!1}}isFile(){try{var stats=FS.lstatSync(this._filename);return stats.isFile()}catch(e){return!1}}isSymbolicLink(){try{var stats=FS.lstatSync(this._filename);return stats.isSymbolickLink()}catch(e){return!1}}getFileSize(){try{var stats=FS.statSync(this._filename);return stats.size}catch(e){return!1}}getModificationTime(){try{var stats=FS.statSync(this._filename);return stats.mtime}catch(e){return!1}}isSpecialDirectory(){return"."==this._filename||".."==this._filename}static posixStyle(path){return expect(path,"String"),path.replace(/\\/g,"/")}static windowsStyle(path){return expect(path,"String"),path.replace(/\//g,"\\")}};